<div class="container py-4">

  <!-- Page Title -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0">{{title}}</h2>
    <a href="/staff/crm/new" class="btn btn-success">Add New Customer</a>
  </div>

  <!-- Filters / Search -->
  <form method="GET" class="row g-3 mb-4 align-items-end">
    <div class="col-12 col-md-6 col-lg-4">
      <label for="search" class="form-label visually-hidden">Search</label>
      <input type="text" id="search" name="search" value="{{filters.search}}" class="form-control"
        placeholder="Search by name or email">
    </div>

    <div class="col-6 col-md-3 col-lg-2">
      <label for="active" class="form-label visually-hidden">Status</label>
      <select id="active" name="active" class="form-select">
        <option value="">All Statuses</option>
        <option value="1" {{#ifEquals filters.active "1" }}selected{{/ifEquals}}>Active</option>
        <option value="0" {{#ifEquals filters.active "0" }}selected{{/ifEquals}}>Inactive</option>
      </select>
    </div>

    <div class="col-6 col-md-3 col-lg-2">
      <label for="storeId" class="form-label visually-hidden">Store</label>
      <select id="storeId" name="storeId" class="form-select">
        <option value="">All Stores</option>
        {{#each stores}}
        <option value="{{this.store_id}}" {{#ifEquals ../filters.storeId this.store_id}}selected{{/ifEquals}}>
          {{this.name}}
        </option>
        {{/each}}
      </select>
    </div>

    <div class="col-12 col-md-6 col-lg-4 col-xl-3">
      <label for="sort" class="form-label visually-hidden">Sort</label>
      <select id="sort" name="sort" class="form-select">
        <option value="lastName,asc" {{#ifEquals filters.sort "lastName,asc" }}selected{{/ifEquals}}>Last Name A–Z
        </option>
        <option value="lastName,desc" {{#ifEquals filters.sort "lastName,desc" }}selected{{/ifEquals}}>Last Name Z–A
        </option>
        <option value="createDate,asc" {{#ifEquals filters.sort "createDate,asc" }}selected{{/ifEquals}}>Oldest First
        </option>
        <option value="createDate,desc" {{#ifEquals filters.sort "createDate,desc" }}selected{{/ifEquals}}>Newest First
        </option>
      </select>
    </div>

    <div class="col-12 d-flex flex-wrap gap-2">
      <button type="submit" class="btn btn-primary flex-grow-1 flex-md-grow-0">Apply</button>
      <a href="/staff/crm" class="btn btn-outline-secondary flex-grow-1 flex-md-grow-0">Clear</a>
    </div>

    <!-- Customer Count / No Results -->
    <div class="mt-3 col-12">
      {{#if customers.length}}
      <small class="text-muted">Showing {{customers.length}} of {{total}} customers (Page {{page}} of
        {{totalPages}})</small>
      {{else}}
      <div class="alert alert-warning" role="alert">No customers found matching your criteria.</div>
      {{/if}}
    </div>
  </form>

  <!-- Customers Grid -->
  <div class="row row-cols-1 row-cols-sm-2 row-cols-xl-3 g-4">
    {{#each customers}}
    <div class="col">
      <div class="card h-100 shadow-sm border-0">
        <div class="card-body d-flex flex-column p-3">

          <!-- Top: Avatar + Name + Contact -->
          <div class="d-flex align-items-start gap-3 mb-2">
            <div class="flex-shrink-0">
              <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center"
                style="width:48px;height:48px;font-weight:600;">
                {{#if avatarInitials}}{{avatarInitials}}{{else}}{{firstName.[0]}}{{lastName.[0]}}{{/if}}
              </div>
            </div>
            <div class="flex-grow-1 min-w-0">
              <h6 class="mb-1 text-truncate" title="{{firstName}} {{lastName}}">{{firstName}} {{lastName}}</h6>
              <small class="text-muted d-block">
                {{#if email}}<a href="mailto:{{email}}" class="text-decoration-none text-muted">{{email}}</a>{{/if}}
              </small>
              {{#if phone}}
              <small class="text-muted d-block"><a href="tel:{{phone}}"
                  class="text-decoration-none text-muted">{{phone}}</a></small>
              {{/if}}
            </div>
          </div>

          <!-- Address -->
          {{#if address}}
          <div class="small text-muted mb-2 text-break" title="{{address}}, {{city}}, {{country}}">
            {{address}}, {{city}}, {{country}}
          </div>
          {{/if}}

          <!-- Badges: store / status / account -->
          <div class="d-flex flex-wrap gap-2 mb-3">
            <span class="badge bg-outline-secondary border text-dark">{{store_name}}</span>
            {{#if active}}
            <span class="badge bg-success">Active</span>
            {{else}}
            <span class="badge bg-danger">Inactive</span>
            {{/if}}
            {{#if hasUserLinked}}
            <span class="badge bg-info text-dark">User Linked</span>
            {{else}}
            <span class="badge bg-secondary">No User</span>
            {{/if}}
          </div>

          <!-- Actions -->
          <div class="mt-auto d-flex gap-2">
            <a href="/staff/crm/{{customerId}}/edit" class="btn btn-sm btn-outline-warning flex-grow-1">Edit</a>
            <a href="/staff/crm/{{customerId}}" class="btn btn-sm btn-outline-primary flex-grow-1">View</a>
          </div>
        </div>
      </div>
    </div>
    {{/each}}
  </div>

  <!-- Pagination -->
  <nav aria-label="Customer pagination" class="mt-4">
    <ul class="pagination justify-content-center flex-wrap">
      {{#if prevPage}}
      <li class="page-item"><a class="page-link" href="{{pageQueryPrefix}}{{prevPage}}">Previous</a></li>
      {{else}}
      <li class="page-item disabled"><span class="page-link">Previous</span></li>
      {{/if}}

      {{#each pagesToShow}}
      {{#if this.ellipsis}}
      <li class="page-item disabled"><span class="page-link">…</span></li>
      {{else}}
      <li class="page-item {{#if this.active}}active{{/if}}">
        {{#if this.active}}
        <span class="page-link">{{this.page}}</span>
        {{else}}
        <a class="page-link" href="{{../pageQueryPrefix}}{{this.page}}">{{this.page}}</a>
        {{/if}}
      </li>
      {{/if}}
      {{/each}}

      {{#if nextPage}}
      <li class="page-item"><a class="page-link" href="{{pageQueryPrefix}}{{nextPage}}">Next</a></li>
      {{else}}
      <li class="page-item disabled"><span class="page-link">Next</span></li>
      {{/if}}
    </ul>
  </nav>
</div>