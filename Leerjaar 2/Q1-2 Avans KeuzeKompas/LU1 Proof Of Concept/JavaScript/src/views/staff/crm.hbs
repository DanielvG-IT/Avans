<div class="container py-4">

  <!-- Page Title -->
  <h2 class="mb-4">{{title}}</h2>

  <!-- Customer Filters / Search / Sorting -->
  <form method="GET" class="mb-4">
    <div class="row g-3 align-items-center">

      <!-- Search Box -->
      <div class="col-12 col-md-6 col-lg-4">
        <label for="search" class="form-label visually-hidden">Search by name or email</label>
        <input type="text" id="search" name="search" value="{{filters.search}}" class="form-control"
          placeholder="Search customers..." aria-label="Search customers by name or email">
      </div>

      <!-- Active Status Filter -->
      <div class="col-6 col-md-3 col-lg-2">
        <label for="active" class="form-label visually-hidden">Filter by status</label>
        <select id="active" name="active" class="form-select" aria-label="Filter by active status">
          <option value="">All Statuses</option>
          <option value="1" {{#ifEquals filters.active "1" }}selected{{/ifEquals}}>Active</option>
          <option value="0" {{#ifEquals filters.active "0" }}selected{{/ifEquals}}>Inactive</option>
        </select>
      </div>

      <!-- Store Filter -->
      <div class="col-6 col-md-3 col-lg-2">
        <label for="storeId" class="form-label visually-hidden">Filter by store</label>
        <select id="storeId" name="storeId" class="form-select" aria-label="Filter by store">
          <option value="">All Stores</option>
          {{#each stores}}
          <option value="{{this.store_id}}" {{#ifEquals ../filters.storeId this.store_id}}selected{{/ifEquals}}>
            {{this.name}}
          </option>
          {{/each}}
        </select>
      </div>

      <!-- Sort Dropdown -->
      <div class="col-12 col-md-6 col-lg-4 col-xl-3">
        <label for="sort" class="form-label visually-hidden">Sort customers</label>
        <select id="sort" name="sort" class="form-select" aria-label="Sort customers">
          <option value="lastName,asc" {{#ifEquals filters.sort "lastName,asc" }}selected{{/ifEquals}}>Last Name A–Z
          </option>
          <option value="lastName,desc" {{#ifEquals filters.sort "lastName,desc" }}selected{{/ifEquals}}>Last Name Z–A
          </option>
          <option value="createDate,asc" {{#ifEquals filters.sort "createDate,asc" }}selected{{/ifEquals}}>Oldest First
          </option>
          <option value="createDate,desc" {{#ifEquals filters.sort "createDate,desc" }}selected{{/ifEquals}}>Newest
            First
          </option>
        </select>
      </div>

      <!-- Apply / Clear Buttons -->
      <div class="col-12 d-flex flex-wrap gap-2">
        <button type="submit" class="btn btn-primary flex-grow-1 flex-md-grow-0">Apply</button>
        <a href="/staff/crm" class="btn btn-outline-secondary flex-grow-1 flex-md-grow-0">Clear</a>
        <a href="/staff/crm/new" class="btn btn-success ms-md-auto">Add New Customer</a>
      </div>
    </div>

    <!-- Customer Count / No Results -->
    <div class="mt-3">
      {{#if customers.length}}
      <div class="text-light">
        Showing {{customers.length}} of {{total}} customers (Page {{page}} of {{totalPages}})
      </div>
      {{else}}
      <div class="alert alert-warning" role="alert">
        No customers found matching your criteria.
      </div>
      {{/if}}
    </div>
  </form>

  <!-- Customers Grid -->
  <div class="row row-cols-1 row-cols-sm-2 row-cols-xl-3 g-4 align-items-stretch">
    {{#each customers}}
    <div class="col">
      <div class="card h-100 shadow-sm border-0">
        <div class="card-body d-flex flex-column p-3">

          <!-- Top: Avatar + Primary info -->
          <div class="d-flex align-items-start gap-3">
            <!-- Simple avatar/icon -->
            <div class="flex-shrink-0">
              <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center"
                style="width:48px;height:48px;font-weight:600;">
                <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" viewBox="0 0 16 16">
                  <path d="M3 14s-1 0-1-1 1-4 6-4 6 3 6 4-1 1-1 1H3z" />
                  <path fill-rule="evenodd" d="M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6z" />
                </svg>
              </div>
            </div>

            <div class="flex-grow-1 min-w-0">
              <h6 class="mb-1 text-truncate" title="{{#if name}}{{name}}{{else}}{{firstName}} {{lastName}}{{/if}}">
                {{#if name}}{{name}}{{else}}{{firstName}} {{lastName}}{{/if}}
              </h6>

              <div class="small text-muted lh-1">
                {{#if email}}
                <div class="d-inline-block" title="{{email}}">
                  <a href="mailto:{{email}}" class="text-decoration-none text-muted">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor"
                      class="bi bi-envelope me-1" viewBox="0 0 16 16">
                      <path d="M0 4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v.217l-8 4.8-8-4.8V4z" />
                      <path
                        d="M0 6.383V12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V6.383l-7.555 4.533a1 1 0 0 1-1.11 0L0 6.383z" />
                    </svg>{{email}}
                  </a>
                </div>
                {{/if}}

                {{#if phone}}
                <div class="mt-1">
                  <a href="tel:{{phone}}" class="text-decoration-none text-muted" title="{{phone}}">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor"
                      class="bi bi-telephone me-1" viewBox="0 0 16 16">
                      <path
                        d="M3.654 1.328a.678.678 0 0 1 .76-.07l2.522 1.26c.329.164.445.555.273.86L6.2 5.08a.678.678 0 0 1-.746.306l-1.1-.33a11.72 11.72 0 0 0 5.516 5.516l.33-1.1a.678.678 0 0 1 .306-.746l1.671-1.009c.305-.172.696-.056.86.273l1.26 2.522a.678.678 0 0 1-.07.76l-2.034 2.034c-.58.58-1.45.77-2.21.49C5.261 13.58 2.42 10.74 1.34 7.158c-.28-.76-.09-1.63.49-2.21L3.654 1.328z" />
                    </svg>{{phone}}
                  </a>
                </div>
                {{/if}}
              </div>

              {{#if address}}
              <div class="mt-2 small text-muted text-break"
                title="{{address}}{{#if postalCode}}, {{postalCode}}{{/if}}{{#if city}}, {{city}}{{/if}}{{#if country}}, {{country}}{{/if}}">
                {{address}}{{#if postalCode}}, {{postalCode}}{{/if}}{{#if city}}, {{city}}{{/if}}{{#if country}},
                {{country}}{{/if}}
              </div>
              {{/if}}
            </div>
          </div>

          <!-- Badges: store / status / account -->
          <div class="mt-3 d-flex flex-wrap gap-2 pb-2">
            <span class="badge bg-outline-secondary border text-dark">{{store_name}}</span>

            {{#if active}}
            <span class="badge bg-success">Active</span>
            {{else}}
            <span class="badge bg-danger">Inactive</span>
            {{/if}}

            {{#if hasUserLinked}}
            <span class="badge bg-info text-dark">User Linked</span>
            {{else}}
            <span class="badge bg-secondary">No User</span>
            {{/if}}
          </div>

          <!-- Footer actions -->
          <div class="d-flex align-items-center justify-content-between pt-2 mt-auto">
            <div class="btn-group">
              <a href="/staff/crm/{{customerId}}/edit" class="btn btn-sm btn-outline-warning">Edit</a>
              <a href="/staff/crm/{{customerId}}" class="btn btn-sm btn-outline-primary">View</a>
            </div>
          </div>
        </div>
      </div>
    </div>
    {{/each}}
  </div>

  <!-- Pagination -->
  <nav aria-label="Customer pagination" class="mt-4">

    <!-- Mobile: simplified controls -->
    <div class="d-flex d-sm-none justify-content-between align-items-center">
      <!-- Previous -->
      {{#if prevPage}}
      <a class="btn btn-outline-primary btn-sm" href="{{pageQueryPrefix}}{{prevPage}}"
        aria-label="Previous page">Prev</a>
      {{else}}
      <span class="btn btn-outline-secondary btn-sm disabled" aria-hidden="true">Prev</span>
      {{/if}}

      <!-- Current page (find active) -->
      <small class="text-light mx-2">
        Page
        {{#each pagesToShow}}
        {{#if this.active}}{{this.page}}{{/if}}
        {{/each}}
        of {{totalPages}}
      </small>

      <!-- Next -->
      {{#if nextPage}}
      <a class="btn btn-outline-primary btn-sm" href="{{pageQueryPrefix}}{{nextPage}}" aria-label="Next page">Next</a>
      {{else}}
      <span class="btn btn-outline-secondary btn-sm disabled" aria-hidden="true">Next</span>
      {{/if}}
    </div>

    <!-- Desktop / Tablet: full pagination -->
    <ul class="pagination justify-content-center flex-wrap d-none d-sm-flex mt-3" role="navigation"
      aria-label="Pagination">
      <!-- Previous -->
      <li class="page-item {{#unless prevPage}}disabled{{/unless}} me-1 mb-1">
        {{#if prevPage}}
        <a class="page-link px-3 py-1" href="{{pageQueryPrefix}}{{prevPage}}" aria-label="Previous">Previous</a>
        {{else}}
        <span class="page-link px-3 py-1" aria-hidden="true">Previous</span>
        {{/if}}
      </li>

      <!-- Page buttons (server-generated array) -->
      {{#each pagesToShow}}
      {{#if this.ellipsis}}
      <li class="page-item disabled me-1 mb-1" aria-hidden="true"><span class="page-link px-3 py-1">…</span></li>
      {{else}}
      <li class="page-item {{#if this.active}}active{{/if}} me-1 mb-1">
        {{#if this.active}}
        <span class="page-link px-3 py-1" aria-current="page">{{this.page}} <span
            class="visually-hidden">(current)</span></span>
        {{else}}
        <a class="page-link px-3 py-1" href="{{../pageQueryPrefix}}{{this.page}}">{{this.page}}</a>
        {{/if}}
      </li>
      {{/if}}
      {{/each}}

      <!-- Next -->
      <li class="page-item {{#unless nextPage}}disabled{{/unless}} me-1 mb-1">
        {{#if nextPage}}
        <a class="page-link px-3 py-1" href="{{pageQueryPrefix}}{{nextPage}}" aria-label="Next">Next</a>
        {{else}}
        <span class="page-link px-3 py-1" aria-hidden="true">Next</span>
        {{/if}}
      </li>
    </ul>
  </nav>
</div>