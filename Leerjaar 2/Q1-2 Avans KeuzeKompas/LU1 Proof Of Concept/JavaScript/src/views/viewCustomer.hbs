<div class="container mt-4 staff-customer-view">
  <!-- Header / Profile Section -->
  <header class="d-flex align-items-center mb-4">
    <div class="me-3 avatar-placeholder" aria-hidden="true">
      <!-- Optional: customer avatar if available -->
      {{#if customer.avatarUrl}}
      <img src="{{customer.avatarUrl}}" alt="{{customer.first_name}} avatar" class="rounded-circle"
        style="width:72px;height:72px;object-fit:cover;">
      {{else}}
      <div class="rounded-circle bg-secondary text-white d-flex justify-content-center align-items-center"
        style="width:72px;height:72px;">
        {{customer.first_name.[0]}}
      </div>
      {{/if}}
    </div>

    <div class="flex-grow-1">
      <h1 class="h4 mb-1">{{customer.first_name}} {{customer.last_name}}</h1>
      <div class="text-light small">
        {{#if customer.email}}<div>Email: <a href="mailto:{{customer.email}}">{{customer.email}}</a></div>{{/if}}
        {{#if customer.phone}}<div>Phone: <a href="tel:{{customer.phone}}">{{customer.phone}}</a></div>{{/if}}
        {{#if customer.address}}<div>Address: {{customer.address}}</div>{{/if}}
      </div>
    </div>

    <div class="text-end">
      <div>
        {{!-- Status badge --}}
        {{#if (eq customer.status "active")}}
        <span class="badge bg-success">Active</span>
        {{else if (eq customer.status "inactive")}}
        <span class="badge bg-secondary">Inactive</span>
        {{else if (eq customer.status "banned")}}
        <span class="badge bg-danger">Banned</span>
        {{else}}
        <span class="badge bg-light text-dark">{{customer.status}}</span>
        {{/if}}
      </div>
    </div>
  </header>

  <!-- Key Metrics / Badges -->
  <section class="mb-4">
    <div class="row g-2">
      <div class="col-auto">
        <div class="card p-2 text-center">
          <div class="h6 mb-0">Active Rentals</div>
          <div class="fs-4 fw-bold">{{metrics.activeRentalsCount}}</div>
        </div>
      </div>

      {{#if (gt metrics.overdueRentalsCount 0)}}
      <div class="col-auto">
        <div class="card p-2 text-center bg-danger text-white">
          <div class="h6 mb-0">Overdue</div>
          <div class="fs-4 fw-bold">
            {{metrics.overdueRentalsCount}}
          </div>
        </div>
      </div>
      {{else}}
      <div class="col-auto">
        <div class="card p-2 text-center">
          <div class="h6 mb-0">Overdue</div>
          <div class="fs-4 fw-bold">
            {{metrics.overdueRentalsCount}}
          </div>
        </div>
      </div>
      {{/if}}

      <div class="col-auto">
        <div class="card p-2 text-center">
          <div class="h6 mb-0">Total Rentals</div>
          <div class="fs-4 fw-bold">{{metrics.totalRentals}}</div>
        </div>
      </div>
    </div>
  </section>

  <div class="row">
    <!-- Rentals Section (Main column) -->
    <div class="col-lg-8">
      <!-- Active Rentals (always shown at top) -->
      <section class="mb-4">
        <h2 class="h6">Active Rentals</h2>
        {{#if activeRentals.length}}
        <table class="table table-sm table-hover">
          <thead>
            <tr>
              <th>Rental #</th>
              <th>Item</th>
              <th>Start</th>
              <th>End</th>
              <th>Status</th>
              <th class="text-end">Actions</th>
            </tr>
          </thead>
          <tbody>
            {{#each activeRentals}}
            <tr class="{{#if this.isHighlighted}}table-info{{else}}{{/if}}">
              <td>
                {{#if this.rentalId}}{{this.rentalId}}{{else}}{{this.rental_id}}{{/if}}
              </td>
              <td>
                {{#if this.itemName}}{{this.itemName}}{{else}}{{this.title}}{{/if}}
              </td>
              <td>
                {{#if this.startDate}}{{formatDate this.startDate}}{{else}}{{formatDate this.rental_date}}{{/if}}
              </td>
              <td class="{{#if this.isOverdue}}text-danger{{else}}{{#if this.is_overdue}}text-danger{{/if}}{{/if}}">
                {{#if this.endDate}}{{formatDate this.endDate}}{{else}}{{formatDate this.due_date}}{{/if}}
              </td>
              <td>
                {{#if this.isReturned}}
                <span class="badge bg-secondary">Returned</span>
                {{else if this.is_returned}}
                <span class="badge bg-secondary">Returned</span>
                {{else if this.isOverdue}}
                <span class="badge bg-danger">Overdue</span>
                {{else if this.is_overdue}}
                <span class="badge bg-danger">Overdue</span>
                {{else if this.rental_status}}
                <span class="badge bg-info text-dark">{{this.rental_status}}</span>
                {{else}}
                <span class="badge bg-success">Active</span>
                {{/if}}
              </td>
              <td class="text-end">
                {{#if (eq user.role 'STAFF')}}
                <a href="/staff/rentals/{{this.rental_id}}/return" class="btn btn-sm btn-outline-primary">Mark
                  returned</a>
                {{/if}}
              </td>
            </tr>
            {{/each}}
          </tbody>
        </table>
        {{else}}
        <div class="alert alert-light">No active rentals.</div>
        {{/if}}
      </section>

      <!-- Future Rentals -->
      <section class="mb-4">
        <h2 class="h6">Upcoming Rentals</h2>
        {{#if futureRentals.length}}
        <table class="table table-sm">
          <thead>
            <tr>
              <th>Rental #</th>
              <th>Item</th>
              <th>Start</th>
              <th>End</th>
              <th>Status</th>
              <th class="text-end">Actions</th>
            </tr>
          </thead>
          <tbody>
            {{#each futureRentals}}
            <tr class="{{#if this.isHighlighted}}table-info{{/if}}">
              <td>{{this.rental_id}}</td>
              <td>{{this.title}}</td>
              <td>
                {{#if this.startDate}}
                {{formatDate this.startDate}}
                {{else}}
                {{formatDate this.rental_date}}
                {{/if}}
              </td>
              <td class="{{#if this.isOverdue}}text-danger{{else}}{{#if this.is_overdue}}text-danger{{/if}}{{/if}}">
                {{#if this.endDate}}
                {{formatDate this.endDate}}
                {{else}}
                {{formatDate this.due_date}}
                {{/if}}
              </td>
              <td>
                {{#if this.isReturned}}
                <span class="badge bg-secondary">Returned</span>
                {{else if this.is_returned}}
                <span class="badge bg-secondary">Returned</span>
                {{else if this.isOverdue}}
                <span class="badge bg-danger">Overdue</span>
                {{else if this.is_overdue}}
                <span class="badge bg-danger">Overdue</span>
                {{else if this.rental_status}}
                <span class="badge bg-info text-dark">{{this.rental_status}}</span>
                {{else}}
                <span class="badge bg-primary">Scheduled</span>
                {{/if}}
              </td>
              <td class="text-end">
                {{!-- ACTIONS --}}
              </td>
            </tr>
            {{/each}}
          </tbody>
        </table>
        {{else}}
        <div class="text-light small">No upcoming rentals.</div>
        {{/if}}
      </section>

      <!-- Past Rentals (collapsible) -->
      <section class="mb-4">
        <details>
          <summary class="mb-2"><strong>Past Rentals</strong> ({{pastRentals.length}})</summary>
          {{#if pastRentals.length}}
          <table class="table table-sm">
            <thead>
              <tr>
                <th>Rental #</th>
                <th>Item</th>
                <th>Start</th>
                <th>Return</th>
                <th>Due</th>
                <th>Status</th>
                <th>Staff</th>
                <th class="text-end">Actions</th>
              </tr>
            </thead>
            <tbody>
              {{#each pastRentals}}
              <tr class="{{#if this.isHighlighted}}table-info{{/if}}">
                <td>
                  {{#if this.rentalId}}{{this.rentalId}}{{else}}{{this.rental_id}}{{/if}}
                </td>
                <td>{{#if this.itemName}}{{this.itemName}}{{else}}{{this.title}}{{/if}}</td>
                <td>
                  {{#if this.startDate}}{{formatDate this.startDate}}{{else}}{{formatDate this.rental_date}}{{/if}}
                </td>
                <td class="{{#if this.isOverdue}}text-danger{{else}}{{#if this.is_overdue}}text-danger{{/if}}{{/if}}">
                  {{#if this.endDate}}{{formatDate this.endDate}}
                  {{else if this.return_date}}{{formatDate this.return_date}}
                  {{else}}{{/if}}
                </td>
                <td>{{#if this.dueDate}}{{formatDate this.dueDate}}{{else}}{{formatDate this.due_date}}{{/if}}</td>
                <td>
                  {{#if this.isReturned}}
                  <span class="badge bg-secondary">Returned</span>
                  {{else if this.is_returned}}
                  <span class="badge bg-secondary">Returned</span>
                  {{else if this.isOverdue}}
                  <span class="badge bg-danger">Overdue</span>
                  {{else if this.is_overdue}}
                  <span class="badge bg-danger">Overdue</span>
                  {{else if this.rental_status}}
                  <span class="badge bg-info text-dark">{{this.rental_status}}</span>
                  {{else}}
                  <span class="badge bg-light text-dark">Past</span>
                  {{/if}}
                </td>
                <td>
                  {{#if this.staff_first_name}}{{this.staff_first_name}} {{this.staff_last_name}}{{/if}}
                </td>
                <td class="text-end">
                  {{!-- ACTIONS --}}
                </td>
              </tr>
              {{/each}}
            </tbody>
          </table>
          {{else}}
          <div class="text-light small">No past rentals.</div>
          {{/if}}
        </details>
      </section>
    </div>

    <!-- Actions / Side Column -->
    <aside class="col-lg-4">
      <div class="card mb-3 p-3">
        <h3 class="h6 mb-3">Actions</h3>

        <div class="d-grid gap-2 mb-2">
          {{#if (eq user.role "STAFF")}}
          <a href="/staff/crm/{{customer.customer_id}}/rent" class="btn btn-primary">Create New Rental</a>
          {{/if}}

          {{#if (eq user.role "STAFF")}}
          <a href="/staff/crm/{{customer.customer_id}}/edit" class="btn btn-warning">Edit Contact Details</a>
          {{else}}
          <a href="/customer/edit" class="btn btn-warning">Edit Contact Details</a>
          {{/if}}

          {{#if (eq user.role "STAFF")}}
          <div class="position-relative">
            <a href="/staff/crm/{{customer.customer_id}}/invoices" class="btn btn-outline-secondary d-block"
              style="pointer-events:none; opacity:0.6;" aria-disabled="true" tabindex="-1">
              View Payment History / Invoices
            </a>

            <div class="position-absolute top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center"
              role="status" aria-label="Coming soon overlay" style="pointer-events:auto;
                        background: repeating-linear-gradient(135deg,
                          rgba(128,128,128,0.16) 0 10px,
                          rgba(255,255,255,0.02) 10px 20px);
                        -webkit-mask: linear-gradient(#000, #000);
                        color:#444;">
              <span class="fw-bold bg-white bg-opacity-75 py-1 px-2 rounded" style="color:#333;">
                Coming Soon
              </span>
            </div>
          </div>
          {{/if}}
        </div>
      </div>
    </aside>
  </div>
</div>