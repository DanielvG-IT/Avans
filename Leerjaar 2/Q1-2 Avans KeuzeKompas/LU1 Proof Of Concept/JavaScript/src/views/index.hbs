<div class="container mt-4">
    <h3>Popular Movies</h3>
    <div id="popularCarousel" class="carousel slide position-relative" data-bs-interval="false">
        <div class="carousel-inner" id="popularInner"></div>
        <!-- Controls -->
        <button class="carousel-control-prev btn-control" type="button" data-bs-target="#popularCarousel"
            data-bs-slide="prev" aria-label="Previous">
            <span class="visually-hidden">Previous</span>
            <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true" focusable="false" style="color:#6c757d;">
                <use xlink:href="/images/sprite.svg#icon-arrow-left"></use>
            </svg>
        </button>
        <button class="carousel-control-next btn-control" type="button" data-bs-target="#popularCarousel"
            data-bs-slide="next" aria-label="Next">
            <span class="visually-hidden">Next</span>
            <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true" focusable="false" style="color:#6c757d;">
                <use xlink:href="/images/sprite.svg#icon-arrow-right"></use>
            </svg>
        </button>
    </div>
</div>

<div class="container mt-4">
    <h3>Longest Movies</h3>
    <div id="longestCarousel" class="carousel slide position-relative" data-bs-interval="false">
        <div class="carousel-inner" id="longestInner"></div>
        <!-- Controls -->
        <button class="carousel-control-prev btn-control" type="button" data-bs-target="#longestCarousel"
            data-bs-slide="prev" aria-label="Previous">
            <span class="visually-hidden">Previous</span>
            <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true" focusable="false" style="color:#6c757d;">
                <use xlink:href="/images/sprite.svg#icon-arrow-left"></use>
            </svg>
        </button>
        <button class="carousel-control-next btn-control" type="button" data-bs-target="#longestCarousel"
            data-bs-slide="next" aria-label="Next">
            <span class="visually-hidden">Next</span>
            <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true" focusable="false" style="color:#6c757d;">
                <use xlink:href="/images/sprite.svg#icon-arrow-right"></use>
            </svg>
        </button>
    </div>
</div>

<div class="container mt-4">
    <h3>Cheapest Movies</h3>
    <div id="cheapestCarousel" class="carousel slide position-relative" data-bs-interval="false">
        <div class="carousel-inner" id="cheapestInner"></div>
        <!-- Controls -->
        <button class="carousel-control-prev btn-control" type="button" data-bs-target="#cheapestCarousel"
            data-bs-slide="prev" aria-label="Previous">
            <span class="visually-hidden">Previous</span>
            <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true" focusable="false" style="color:#6c757d;">
                <use xlink:href="/images/sprite.svg#icon-arrow-left"></use>
            </svg>
        </button>
        <button class="carousel-control-next btn-control" type="button" data-bs-target="#cheapestCarousel"
            data-bs-slide="next" aria-label="Next">
            <span class="visually-hidden">Next</span>
            <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true" focusable="false" style="color:#6c757d;">
                <use xlink:href="/images/sprite.svg#icon-arrow-right"></use>
            </svg>
        </button>
    </div>
</div>

<!-- JSON Data -->
<script id="popularMoviesJson" type="application/json">
  {{{json popularMovies}}}
</script>
<script id="longestMoviesJson" type="application/json">
  {{{json longestMovies}}}
</script>
<script id="cheapestMoviesJson" type="application/json">
  {{{json cheapestMovies}}}
</script>

<script>
    (function () {
        function itemsPerSlide() {
            const w = window.innerWidth;
            if (w < 576) return 2;
            if (w < 768) return 3;
            if (w < 1400) return 4;
            return 6;
        }

        function buildSlide(items, isActive) {
            const div = document.createElement('div');
            div.className = 'carousel-item' + (isActive ? ' active' : '');
            const row = document.createElement('div');
            row.className = 'd-flex flex-wrap justify-content-center gap-2 slide-grid';
            items.forEach(m => {
                const card = document.createElement('div');
                card.className = 'movie-card';
                card.innerHTML = `
        <a href="/movies/${m.filmId}" class="movie-link" aria-label="${m.title}">
          <div class="card h-100 shadow-sm">
            ${m.coverUrl ? `
              <div class="poster">
                <img src="${m.coverUrl}" class="card-img-top" alt="${m.title}">
              </div>` : `
              <div class="poster placeholder" aria-hidden="true">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none">
                  <rect width="24" height="24" rx="2" fill="#e0e0e0"></rect>
                  <path d="M5 16L9 11l3 4 4-6 4 7H5z" fill="#cfcfcf"></path>
                </svg>
              </div>`}
            <div class="card-body p-2">
              <h6 class="card-title mb-0" title="${m.title}">${m.title}</h6>
              ${m.category ? `<span class="badge bg-primary mb-2">${m.category}</span>` : ''}
              ${m.rentalRate != null ? `<span class="badge bg-warning text-dark mb-2">â‚¬${typeof m.rentalRate === 'number' ? m.rentalRate.toFixed(2) : m.rentalRate}</span>` : ''}
              ${m.rentalCount != null ? `<span class="badge bg-success mb-2">Rented ${m.rentalCount}</span>` : ''}
              ${m.length != null ? `<span class="badge bg-secondary mb-2">${m.length} min</span>` : ''}
            </div>
          </div>
        </a>`;
                row.appendChild(card);
            });
            div.appendChild(row);
            return div;
        }

        function initCarousel(jsonId, innerId) {
            const movies = JSON.parse(document.getElementById(jsonId).textContent || '[]');
            const carouselInner = document.getElementById(innerId);
            let currentPerSlide = null;

            function rebuild() {
                const per = itemsPerSlide();
                if (per === currentPerSlide) return;
                currentPerSlide = per;

                carouselInner.innerHTML = '';
                for (let i = 0; i < movies.length; i += per) {
                    const slice = movies.slice(i, i + per);
                    carouselInner.appendChild(buildSlide(slice, i === 0));
                }
            }

            window.addEventListener('resize', () => {
                clearTimeout(carouselInner._resizeTimer);
                carouselInner._resizeTimer = setTimeout(rebuild, 120);
            });

            rebuild();
        }

        initCarousel('popularMoviesJson', 'popularInner');
        initCarousel('longestMoviesJson', 'longestInner');
        initCarousel('cheapestMoviesJson', 'cheapestInner');
    })();
</script>

<style>
    .movie-card {
        flex: 1 0 auto;
        max-width: 180px;
    }

    .slide-grid {
        padding-top: 4px;
    }

    @media (max-width: 575.98px) {
        .movie-card {
            max-width: 48%;
        }
    }

    @media (min-width: 576px) and (max-width: 767.98px) {
        .movie-card {
            max-width: 30%;
        }
    }

    @media (min-width: 768px) and (max-width: 991.98px) {
        .movie-card {
            max-width: 23%;
        }
    }

    @media (min-width: 992px) and (max-width: 1399.98px) {
        .movie-card {
            max-width: 18.5%;
        }
    }

    @media (min-width: 1400px) {
        .movie-card {
            max-width: 15%;
        }
    }

    .movie-card .card {
        border-radius: 8px;
        overflow: hidden;
        cursor: pointer;
        transition: transform .15s ease;
    }

    .movie-card .card:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
    }

    .poster {
        width: 100%;
        aspect-ratio: 2 / 3;
        overflow: hidden;
        background: #f2f2f2;
    }

    .poster img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
    }

    .poster.placeholder {
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .card-title {
        font-size: .9rem;
        line-height: 1.2;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .movie-link {
        text-decoration: none;
        color: inherit;
        display: block;
    }

    /* Controls */
    .carousel-control-prev.btn-control,
    .carousel-control-next.btn-control {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        width: 44px;
        height: 44px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #e9ecef;
        border: 1px solid rgba(0, 0, 0, 0.08);
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.06);
        transition: background .12s ease;
        pointer-events: auto;
    }

    .carousel-control-prev.btn-control:hover,
    .carousel-control-next.btn-control:hover {
        background: #e0e0e0;
    }
</style>