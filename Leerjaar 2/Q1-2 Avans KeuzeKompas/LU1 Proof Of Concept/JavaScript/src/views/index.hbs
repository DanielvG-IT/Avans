<div class='container mt-4'>
    <h3>Popular Movies</h3>

    <!-- Carousel -->
    <div id='movieCarousel' class='carousel slide position-relative' data-bs-interval='false'
        aria-label="Popular movies carousel">
        <div class='carousel-inner' id='carouselInner' aria-live="polite"></div>

        <!-- Controls -->
        <button class="carousel-control-prev btn-control" type="button" data-bs-target="#movieCarousel"
            data-bs-slide="prev" aria-label="Previous"
            style="pointer-events:auto; width:44px; height:44px; border-radius:50%; display:flex; align-items:center; justify-content:center; background:#e9ecef; border:1px solid rgba(0,0,0,0.08); box-shadow:0 4px 10px rgba(0,0,0,0.06); transition:background .12s ease;"
            onmouseenter="this.style.background='#e0e0e0';" onmouseleave="this.style.background='#e9ecef';">
            <span class="visually-hidden">Previous</span>
            <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true" focusable="false" style="color:#6c757d;">
                <use xlink:href="/images/sprite.svg#icon-arrow-left"></use>
            </svg>
        </button>
        <button class="carousel-control-next btn-control" type="button" data-bs-target="#movieCarousel"
            data-bs-slide="next" aria-label="Next"
            style="pointer-events:auto; width:44px; height:44px; border-radius:50%; display:flex; align-items:center; justify-content:center; background:#e9ecef; border:1px solid rgba(0,0,0,0.08); box-shadow:0 4px 10px rgba(0,0,0,0.06); transition:background .12s ease;"
            onmouseenter="this.style.background='#e0e0e0';" onmouseleave="this.style.background='#e9ecef';">
            <span class="visually-hidden">Next</span>
            <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true" focusable="false" style="color:#6c757d;">
                <use xlink:href="/images/sprite.svg#icon-arrow-right"></use>
            </svg>
        </button>
    </div>
</div>

<script id="moviesJson" type="application/json">
{{{json model.movies}}}
</script>

<script>
    (function () {
        const movies = JSON.parse(document.getElementById('moviesJson').textContent || '[]');
        const carouselInner = document.getElementById('carouselInner');

        function itemsPerSlide() {
            const w = window.innerWidth;
            if (w < 576) return 2;          // mobile
            if (w < 768) return 3;          // sm tablets
            if (w < 1400) return 4;         // md + lg
            return 6;                       // xl+
        }

        function buildSlide(items, isActive) {
            const div = document.createElement('div');
            div.className = 'carousel-item' + (isActive ? ' active' : '');
            const row = document.createElement('div');
            row.className = 'd-flex flex-wrap justify-content-center gap-2 slide-grid';
            items.forEach(m => {
                const card = document.createElement('div');
                card.className = 'movie-card';
                card.innerHTML = `
                <a href="/movies/${m.filmId}" class="movie-link" aria-label="${m.title}">
                    <div class="card h-100 shadow-sm">
                        ${m.coverUrl ? `
                        <div class="poster">
                            <img src="${m.coverUrl}" class="card-img-top" alt="${m.title}">
                        </div>` : `
                        <div class="poster placeholder" aria-hidden="true">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none">
                                <rect width="24" height="24" rx="2" fill="#e0e0e0"></rect>
                                <path d="M5 16L9 11l3 4 4-6 4 7H5z" fill="#cfcfcf"></path>
                            </svg>
                        </div>`}
                        <div class="card-body p-2">
                            <h6 class="card-title mb-0" title="${m.title}">${m.title}</h6>
                            ${m.category ? `<span class="badge bg-primary mb-2">${m.category}</span>` : ''}
                        </div>
                    </div>
                </a>
            `;
                row.appendChild(card);
            });
            div.appendChild(row);
            return div;
        }

        let currentPerSlide = null;

        function rebuild() {
            const per = itemsPerSlide();
            if (per === currentPerSlide) return;
            currentPerSlide = per;

            carouselInner.innerHTML = '';
            for (let i = 0; i < movies.length; i += per) {
                const slice = movies.slice(i, i + per);
                carouselInner.appendChild(buildSlide(slice, i === 0));
            }
        }

        let resizeTimer;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(rebuild, 120);
        });

        rebuild();
    })();
</script>

<style>
    .movie-card {
        flex: 1 0 auto;
        max-width: 180px;
    }

    .slide-grid {
        /* center nicely */
        padding-top: 4px;
    }

    @media (max-width: 575.98px) {
        .movie-card {
            max-width: 48%;
        }
    }

    @media (min-width: 576px) and (max-width: 767.98px) {
        .movie-card {
            max-width: 30%;
        }
    }

    @media (min-width: 768px) and (max-width: 991.98px) {
        .movie-card {
            max-width: 23%;
        }
    }

    @media (min-width: 992px) and (max-width: 1399.98px) {
        .movie-card {
            max-width: 18.5%;
        }
    }

    @media (min-width: 1400px) {
        .movie-card {
            max-width: 15%;
        }
    }

    .movie-card .card {
        border-radius: 8px;
        overflow: hidden;
        cursor: pointer;
        transition: transform .15s ease;
    }

    .movie-card .card:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
    }

    .poster {
        width: 100%;
        aspect-ratio: 2 / 3;
        overflow: hidden;
        background: #f2f2f2;
    }

    .poster img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
    }

    .poster.placeholder {
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .card-title {
        font-size: .9rem;
        line-height: 1.2;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .movie-link {
        text-decoration: none;
        color: inherit;
        display: block;
    }

    /* Center carousel controls vertically */
    .carousel-control-prev.btn-control,
    .carousel-control-next.btn-control {
        position: absolute;
        top: 50%;
        bottom: auto;
        transform: translateY(-50%);
        width: 44px;
        height: 44px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #e9ecef;
        border: 1px solid rgba(0, 0, 0, 0.08);
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.06);
        transition: background .12s ease;
        pointer-events: auto;
    }

    .carousel-control-prev.btn-control:hover,
    .carousel-control-next.btn-control:hover {
        background: #e0e0e0;
    }
</style>